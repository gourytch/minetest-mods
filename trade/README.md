TRADE - обмен между игроками
============================

команды
=======

/trade help -- подсказка по командам системы обмена
/trade status -- выдаёт состояние системы обмена
/trade statistic -- выдаёт статистику системы обмена
/trade desk|showdesk -- показывает форму с main- и trade- 
                        списками инвентаря игрока 
                        (чтобы забрать/выложить вещи)
/trade request|with ник -- предлагает обмен игроку 
/trade disable -- блокирует все предложения обмена
/trade enable -- снимает блокировку с предложений обмена
/trade blocklist -- выдаёт список личных блокировок
/trade block [ник] [заметка] -- добавляет игрока в личный блоклист
/trade unblock [ник] -- убирает игрока из личного блоклиста

идеи и полуформальное описание обмена:
======================================

* реализация - двухфазная торговля:
  * фаза 1: наполнение trade-столов, заканчивается тогда, 
    когда оба участника заблокировали свои trade-списки
    (кнопкой LOCK)
  * фаза 2: двустороннее подтверждение сделки (кнопкой ACCEPT)
    либо переход на фазу 1 (сбросом LOCK-состояния своего trade-списка)
    
* у игроков в инвентаре заводим отдельные списки trade
* игрок name1 посылает команду /trade name2
* проверяется, есть ли игроков name1 и name2 возможность торговли
* (есть соответствующие права, не мёртвые ли, нет ли выставленного запрета
  на приём торговли и т.п.)
* у игрока name2 открывается диалоговое окно "игрок name1 предлагает обмен"
  с кнопками "согласиться", "отказаться", "блокировать" и таймер 
  обратного отсчёта
  * при отказе или истечении таймера окно закрывается. конец.
  * при нажатии на "блокировать" окно закрывается, player1 добавляется в 
    ignore-лист у player2. конец.
  * при нажатии на "согласиться" окно закрывается
* начинается сеанс обмена
* заводятся флаги locked и accepted у player1 и player2 (сброшены изначально)
* у игроков открывается форма, где в trade-части слева отображается 
  trade-список своего инвентаря, а справа read-only trade-список 
  инвентаря другого участника; кнопка, переключающая locked-флаг,
  кнопка (disabled) для accept-а, картинки, показывающие состояние флагов
  другого участника, свой main-инвентарь.
* до нажатия кнопки LOCK можно перемещать вещи между main и trade списками
* при нажатии игроком LOCK его trade-список становится readonly, 
  меняется картинка на кнопке.
* если оба LOCK-флага установлены, на формах появляются кнопки ACCEPT
* если какой-нибудь LOCK-флаг сбросился, кнопки ACCEPT пропадают
* если оба флага accepted взведены, то 
  информация о сделке регистрируется в общем списке и историях игроков
  происходит обмен (swap) содержимым trade-списков player1 и player2;
  обмен завершается, формы переключаются на showdesk-ную, конец
* если при периодической проверке обнаруживается, что торговля невозможна,
  то формы торговли у player1 и player2 закрываются, формы переключаются 
  на showdesk-ную, конец.
    
формы:
======

form_request:
 "вам предлагает обмен игрок nickname"
 [согласиться][отказаться][блокировать]

form_showdesk:
 [3x3] - trade-список
 [забрать всё] - кнопка, перемещающая всё содержимое trade в main (если может)
 [8x4] - main-список

form_trade
   [3x3]     [3x3] - списки обмена
  [lock1]   [lock2] -- картинки блокировки
 [accept1] [accept2] -- картинки подтверждения
 [подтвердить обмен] -- кнопка подтверждения обмена.
 [8x4] - main-список
левый trade-инвентарь - интерактивен, правый - readonly

--]]